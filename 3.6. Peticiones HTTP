import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';

void main() {
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return ChangeNotifierProvider(
      create: (context) => MyAppState(),
      child: MaterialApp(
        title: 'PokeApp',
        theme: ThemeData(
          colorScheme: ColorScheme.fromSeed(
              seedColor: const Color.fromARGB(255, 2, 34, 15)),
          useMaterial3: true,
        ),
        home: MyHomePage(),
      ),
    );
  }
}

class MyAppState extends ChangeNotifier {
  String pokemonName = "";
  String pokemonImage = "";
  bool isLoading = false;

  // Función para obtener un Pokémon aleatorio
  Future<void> fetchPokemon() async {
    isLoading = true;
    notifyListeners();

    final randomId = DateTime.now().millisecondsSinceEpoch % 151 + 1; // 1 a 151
    final url = Uri.parse('https://pokeapi.co/api/v2/pokemon/$randomId');

    final response = await http.get(url);

    if (response.statusCode == 200) {
      final data = json.decode(response.body);
      pokemonName = data['name'];
      pokemonImage = data['sprites']['front_default'];
    } else {
      pokemonName = "Error al cargar Pokémon";
      pokemonImage = "";
    }

    isLoading = false;
    notifyListeners();
  }
}

class MyHomePage extends StatefulWidget {
  @override
  State<MyHomePage> createState() => _MyHomePageState();
}

class _MyHomePageState extends State<MyHomePage> {
  var selectedIndex = 0;

  @override
  Widget build(BuildContext context) {
    Widget page;
    switch (selectedIndex) {
      case 0:
        page = GeneratorPage();
      case 1:
        page = FavoritesPage();
      default:
        throw UnimplementedError('no widget for $selectedIndex');
    }

    return Scaffold(
      body: Row(
        children: [
          SafeArea(
            child: NavigationRail(
              extended: false,
              destinations: const [
                NavigationRailDestination(
                  icon: Icon(Icons.home),
                  label: Text('Home'),
                ),
                NavigationRailDestination(
                  icon: Icon(Icons.favorite),
                  label: Text('Favorites'),
                ),
              ],
              selectedIndex: selectedIndex,
              onDestinationSelected: (value) {
                setState(() {
                  selectedIndex = value;
                });
              },
            ),
          ),
          Expanded(
            child: Container(
              color: Theme.of(context).colorScheme.primaryContainer,
              child: page,
            ),
          ),
        ],
      ),
    );
  }
}

class GeneratorPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    var appState = context.watch<MyAppState>();

    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          if (appState.isLoading)
            const CircularProgressIndicator()
          else if (appState.pokemonName.isNotEmpty)
            BigCard(
              name: appState.pokemonName,
              imageUrl: appState.pokemonImage,
            )
          else
            const Text(
              "Presiona el botón para descubrir un Pokémon",
              style: TextStyle(fontSize: 18),
            ),
          const SizedBox(height: 20),
          ElevatedButton(
            onPressed: () {
              appState.fetchPokemon();
            },
            child: const Text('Obtener Pokémon'),
          ),
        ],
      ),
    );
  }
}

class BigCard extends StatelessWidget {
  final String name;
  final String imageUrl;

  const BigCard({
    super.key,
    required this.name,
    required this.imageUrl,
  });

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final style =
        theme.textTheme.displayMedium!.copyWith(color: theme.colorScheme.onPrimary);

    return Card(
      color: theme.colorScheme.primary,
      child: Padding(
        padding: const EdgeInsets.all(20),
        child: Column(
          children: [
            if (imageUrl.isNotEmpty)
              Image.network(imageUrl, width: 150, height: 150),
            const SizedBox(height: 10),
            Text(
              name.toUpperCase(),
              style: style,
            ),
          ],
        ),
      ),
    );
  }
}

class FavoritesPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return const Center(
      child: Text('No favorites yet.'),
    );
  }
}
